<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoL Flash Tracker - Launcher</title>
  <link rel="icon" href="./images/Flash.png" type="image/png" />
  
  <link rel="stylesheet" href="styles.css">
  <script src="modules/config.js"></script>
  <script src="modules/ChampionManager.js"></script>
  <script src="modules/ValidationManager.js"></script>
  <script src="modules/EventManager.js"></script>
  <script src="modules/ConfigManager.js"></script>
  <style>
    /* Diana mode específico */
    body.diana-mode {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.8) 0%, rgba(26, 26, 46, 0.8) 100%), url('./Champions_assets/Diana_0.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* Estilos específicos del launcher */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    .status-dot.warning { background: var(--warning); }
    .status-dot.error { background: var(--error); }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .lang-label {
      font-weight: 500;
      color: var(--text-secondary);
      min-width: 20px;
      text-align: center;
      transition: var(--transition);
    }

    .lang-label.active {
      color: var(--accent-primary);
    }

    /* Animaciones de transición */
    .role-card.fade-out {
      opacity: 0;
      transform: translateY(-15px) scale(0.95);
      pointer-events: none;
    }

    .role-card.fade-in {
      opacity: 0;
      transform: translateY(15px) scale(0.95);
    }

    .role-card.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .action-button.slide-out {
      opacity: 0;
      transform: translateX(-30px) scale(0.95);
      pointer-events: none;
    }

    .action-button.slide-in {
      opacity: 0;
      transform: translateX(30px) scale(0.95);
    }

    .action-button.visible {
      opacity: 1;
      transform: translateX(0) scale(1);
    }

    /* Estilos específicos del tema claro */
    body.light-theme .action-button.host {
      background: linear-gradient(45deg, #7b1fa2, #9c27b0);
      color: #ffffff;
    }

    body.light-theme .action-button.join {
      background: linear-gradient(45deg, #2e7d32, #388e3c);
      color: #ffffff;
    }

    body.light-theme .action-button.solo {
      background: linear-gradient(45deg, #424242, #616161);
      color: #ffffff;
    }

    /* Configuración avanzada específica */
    .advanced-settings {
      width: 100%;
      max-width: 320px;
      margin-top: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      position: relative;
    }

    .advanced-settings summary {
      padding: 12px 16px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      background: var(--bg-card);
      transition: var(--transition);
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .advanced-settings summary::-webkit-details-marker {
      display: none;
    }

    .advanced-settings summary::before {
      content: '⚙️';
      transition: transform 0.3s;
    }

    .advanced-settings[open] summary::before {
      transform: rotate(90deg);
    }

    .advanced-settings[open] .settings-panel {
      max-height: 1200px;
      opacity: 1;
    }

    .settings-panel {
      padding: 16px;
      border-top: 1px solid var(--border);
      background: var(--bg-secondary);
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.6s ease, opacity 0.6s ease, padding 0.6s ease;
    }



    .settings-panel label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .settings-panel input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent-primary);
    }

    .settings-panel select {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-family: inherit;
    }

    /* Elementos específicos del launcher */
    .guest-box::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }

    .guest-box .nickname-container {
      margin-bottom: 20px;
    }

    .guest-box .role-card {
      margin-bottom: 4px;
      border-color: var(--accent-primary);
      background: rgba(187, 134, 252, 0.05);
    }

    .guest-box .action-button {
      margin-top: 0;
    }

    .section-separator {
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border), transparent);
      margin: 24px 0;
      position: relative;
    }

    .section-separator::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-primary);
      padding: 0 8px;
      font-size: 0.8rem;
      color: var(--accent-primary);
    }

    .mode-switch-container { 
      width: 100%; 
      max-width: 320px; 
      margin: 20px 0 16px; 
      font-size: 0.9rem; 
      color: var(--text-muted);
    }

    .switch-wrapper { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: var(--bg-card); 
      padding: 12px 16px; 
      border-radius: var(--radius); 
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .switch-wrapper:hover {
      border-color: var(--accent-primary);
      background: var(--bg-card-hover);
    }

    .switch-label { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      font-weight: 500;
      color: var(--text-secondary);
    }

    .role-card input { 
      position: absolute;
      opacity: 0;
      width: 1px;
      height: 1px;
      pointer-events: none;
    }

    .role-card-content { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      font-weight: 500;
      position: relative;
      z-index: 1;
    }

    .role-icon { 
      width: 32px; 
      height: 32px; 
      background: var(--bg-tertiary); 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 1.2rem;
      transition: var(--transition);
    }

    .role-card:hover .role-icon {
      transform: scale(1.1);
      background: var(--accent-primary);
    }

    .nickname-container {
      position: relative;
      margin-bottom: 16px;
    }

    /* Help button específico */
    #helpBtn:hover {
      opacity: 1;
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(187, 134, 252, 0.1);
    }

    #helpBtn:active {
      transform: scale(0.95);
    }

    #helpBtn.active {
      background: #3b82f6 !important;
      color: white !important;
      border-color: #2563eb !important;
      opacity: 1;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3) !important;
    }

    #helpBtn.active:hover {
      background: #2563eb !important;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.4) !important;
    }

    body.light-theme #helpBtn {
      background: white;
      border-color: #d1d5db;
      color: #6b7280;
    }

    body.light-theme #helpBtn.active {
      background: #3b82f6 !important;
      border-color: #2563eb !important;
      color: white !important;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3) !important;
    }
    
    @keyframes sparkleFloat {
      0% {
        opacity: 1;
        transform: translateY(0) scale(0.5) rotate(0deg);
      }
      50% {
        opacity: 0.8;
        transform: translateY(-20px) scale(1) rotate(180deg);
      }
      100% {
        opacity: 0;
        transform: translateY(-40px) scale(0.3) rotate(360deg);
      }
    }
    
    @keyframes flashSparkle {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(0.3) rotate(0deg);
      }
      50% {
        opacity: 0.9;
        transform: translate(var(--random-x), var(--random-y)) scale(1.2) rotate(180deg);
      }
      100% {
        opacity: 0;
        transform: translate(calc(var(--random-x) * 2), calc(var(--random-y) * 2)) scale(0.2) rotate(360deg);
      }
    }
  </style>
  
  <!-- Pre-carga de recursos -->
  <link rel="preload" href="./images/Bottom_icon.png" as="image">
  <link rel="preload" href="./images/Diana_0.jpg" as="image">
  <link rel="preload" href="./images/Diana.png" as="image">
  <link rel="preload" href="./images/Flash.png" as="image">
  <link rel="preload" href="./images/Jungle_icon.png" as="image">
  <link rel="preload" href="./images/Middle_icon.png" as="image">
  <link rel="preload" href="./images/SummonerBarrier.png" as="image">
  <link rel="preload" href="./images/SummonerBoost.png" as="image">
  <link rel="preload" href="./images/SummonerDot.png" as="image">
  <link rel="preload" href="./images/SummonerExhaust.png" as="image">
  <link rel="preload" href="./images/SummonerHaste.png" as="image">
  <link rel="preload" href="./images/SummonerHeal.png" as="image">
  <link rel="preload" href="./images/SummonerSmite.png" as="image">
  <link rel="preload" href="./images/SummonerTeleport.png" as="image">
  <link rel="preload" href="./images/Support_icon.png" as="image">
  <link rel="preload" href="./images/Top_icon.png" as="image">
  <link rel="preload" href="./sound/Diana_Select.ogg" as="audio">
  <!-- Champion images preload -->
  <link rel="preload" href="./Champions_assets/Aatrox.png" as="image">
  <link rel="preload" href="./Champions_assets/Ahri.png" as="image">
  <link rel="preload" href="./Champions_assets/Akali.png" as="image">
  <link rel="preload" href="./Champions_assets/Akshan.png" as="image">
  <link rel="preload" href="./Champions_assets/Alistar.png" as="image">
  <link rel="preload" href="./Champions_assets/Amumu.png" as="image">
  <link rel="preload" href="./Champions_assets/Anivia.png" as="image">
  <link rel="preload" href="./Champions_assets/Annie.png" as="image">
  <link rel="preload" href="./Champions_assets/Aphelios.png" as="image">
  <link rel="preload" href="./Champions_assets/Ashe.png" as="image">
  <link rel="preload" href="./Champions_assets/Aurelion_Sol.png" as="image">
  <link rel="preload" href="./Champions_assets/Azir.png" as="image">
  <link rel="preload" href="./Champions_assets/Bard.png" as="image">
  <link rel="preload" href="./Champions_assets/Bel'Veth.png" as="image">
  <link rel="preload" href="./Champions_assets/Blitzcrank.png" as="image">
  <link rel="preload" href="./Champions_assets/Brand.png" as="image">
  <link rel="preload" href="./Champions_assets/Braum.png" as="image">
  <link rel="preload" href="./Champions_assets/Briar.png" as="image">
  <link rel="preload" href="./Champions_assets/Caitlyn.png" as="image">
  <link rel="preload" href="./Champions_assets/Camille.png" as="image">
  <link rel="preload" href="./Champions_assets/Cassiopeia.png" as="image">
  <link rel="preload" href="./Champions_assets/Cho'Gath.png" as="image">
  <link rel="preload" href="./Champions_assets/Corki.png" as="image">
  <link rel="preload" href="./Champions_assets/Darius.png" as="image">
  <link rel="preload" href="./Champions_assets/Diana.png" as="image">
  <link rel="preload" href="./Champions_assets/Dr_Mundo.png" as="image">
  <link rel="preload" href="./Champions_assets/Draven.png" as="image">
  <link rel="preload" href="./Champions_assets/Ekko.png" as="image">
  <link rel="preload" href="./Champions_assets/Elise.png" as="image">
  <link rel="preload" href="./Champions_assets/Evelynn.png" as="image">
  <link rel="preload" href="./Champions_assets/Ezreal.png" as="image">
  <link rel="preload" href="./Champions_assets/Fiddlesticks.png" as="image">
  <link rel="preload" href="./Champions_assets/Fiora.png" as="image">
  <link rel="preload" href="./Champions_assets/Fizz.png" as="image">
  <link rel="preload" href="./Champions_assets/Galio.png" as="image">
  <link rel="preload" href="./Champions_assets/Gangplank.png" as="image">
  <link rel="preload" href="./Champions_assets/Garen.png" as="image">
  <link rel="preload" href="./Champions_assets/Gnar.png" as="image">
  <link rel="preload" href="./Champions_assets/Gragas.png" as="image">
  <link rel="preload" href="./Champions_assets/Graves.png" as="image">
  <link rel="preload" href="./Champions_assets/Gwen.png" as="image">
  <link rel="preload" href="./Champions_assets/Hecarim.png" as="image">
  <link rel="preload" href="./Champions_assets/Heimerdinger.png" as="image">
  <link rel="preload" href="./Champions_assets/Hwei.png" as="image">
  <link rel="preload" href="./Champions_assets/Illaoi.png" as="image">
  <link rel="preload" href="./Champions_assets/Irelia.png" as="image">
  <link rel="preload" href="./Champions_assets/Ivern.png" as="image">
  <link rel="preload" href="./Champions_assets/Janna.png" as="image">
  <link rel="preload" href="./Champions_assets/Jarvan_IV.png" as="image">
  <link rel="preload" href="./Champions_assets/Jax.png" as="image">
  <link rel="preload" href="./Champions_assets/Jayce.png" as="image">
  <link rel="preload" href="./Champions_assets/Jhin.png" as="image">
  <link rel="preload" href="./Champions_assets/Jinx.png" as="image">
  <link rel="preload" href="./Champions_assets/K'Sante.png" as="image">
  <link rel="preload" href="./Champions_assets/Kai'Sa.png" as="image">
  <link rel="preload" href="./Champions_assets/Kalista.png" as="image">
  <link rel="preload" href="./Champions_assets/Karma.png" as="image">
  <link rel="preload" href="./Champions_assets/Karthus.png" as="image">
  <link rel="preload" href="./Champions_assets/Kassadin.png" as="image">
  <link rel="preload" href="./Champions_assets/Katarina.png" as="image">
  <link rel="preload" href="./Champions_assets/Kayle.png" as="image">
  <link rel="preload" href="./Champions_assets/Kayn.png" as="image">
  <link rel="preload" href="./Champions_assets/Kennen.png" as="image">
  <link rel="preload" href="./Champions_assets/Kha'Zix.png" as="image">
  <link rel="preload" href="./Champions_assets/Kindred.png" as="image">
  <link rel="preload" href="./Champions_assets/Kled.png" as="image">
  <link rel="preload" href="./Champions_assets/Kog'Maw.png" as="image">
  <link rel="preload" href="./Champions_assets/LeBlanc.png" as="image">
  <link rel="preload" href="./Champions_assets/Lee_Sin.png" as="image">
  <link rel="preload" href="./Champions_assets/Leona.png" as="image">
  <link rel="preload" href="./Champions_assets/Lillia.png" as="image">
  <link rel="preload" href="./Champions_assets/Lissandra.png" as="image">
  <link rel="preload" href="./Champions_assets/Lucian.png" as="image">
  <link rel="preload" href="./Champions_assets/Lulu.png" as="image">
  <link rel="preload" href="./Champions_assets/Lux.png" as="image">
  <link rel="preload" href="./Champions_assets/Malphite.png" as="image">
  <link rel="preload" href="./Champions_assets/Malzahar.png" as="image">
  <link rel="preload" href="./Champions_assets/Maokai.png" as="image">
  <link rel="preload" href="./Champions_assets/Master_Yi.png" as="image">
  <link rel="preload" href="./Champions_assets/Milio.png" as="image">
  <link rel="preload" href="./Champions_assets/Miss_Fortune.png" as="image">
  <link rel="preload" href="./Champions_assets/Mordekaiser.png" as="image">
  <link rel="preload" href="./Champions_assets/Morgana.png" as="image">
  <link rel="preload" href="./Champions_assets/Naafiri.png" as="image">
  <link rel="preload" href="./Champions_assets/Nami.png" as="image">
  <link rel="preload" href="./Champions_assets/Nasus.png" as="image">
  <link rel="preload" href="./Champions_assets/Nautilus.png" as="image">
  <link rel="preload" href="./Champions_assets/Neeko.png" as="image">
  <link rel="preload" href="./Champions_assets/Nidalee.png" as="image">
  <link rel="preload" href="./Champions_assets/Nilah.png" as="image">
  <link rel="preload" href="./Champions_assets/Nocturne.png" as="image">
  <link rel="preload" href="./Champions_assets/Nunu_&_Willump.png" as="image">
  <link rel="preload" href="./Champions_assets/Olaf.png" as="image">
  <link rel="preload" href="./Champions_assets/Orianna.png" as="image">
  <link rel="preload" href="./Champions_assets/Ornn.png" as="image">
  <link rel="preload" href="./Champions_assets/Pantheon.png" as="image">
  <link rel="preload" href="./Champions_assets/Poppy.png" as="image">
  <link rel="preload" href="./Champions_assets/Pyke.png" as="image">
  <link rel="preload" href="./Champions_assets/Qiyana.png" as="image">
  <link rel="preload" href="./Champions_assets/Quinn.png" as="image">
  <link rel="preload" href="./Champions_assets/Rakan.png" as="image">
  <link rel="preload" href="./Champions_assets/Rammus.png" as="image">
  <link rel="preload" href="./Champions_assets/Rek'Sai.png" as="image">
  <link rel="preload" href="./Champions_assets/Rell.png" as="image">
  <link rel="preload" href="./Champions_assets/Renata_Glasc.png" as="image">
  <link rel="preload" href="./Champions_assets/Renekton.png" as="image">
  <link rel="preload" href="./Champions_assets/Rengar.png" as="image">
  <link rel="preload" href="./Champions_assets/Riven.png" as="image">
  <link rel="preload" href="./Champions_assets/Rumble.png" as="image">
  <link rel="preload" href="./Champions_assets/Ryze.png" as="image">
  <link rel="preload" href="./Champions_assets/Samira.png" as="image">
  <link rel="preload" href="./Champions_assets/Sejuani.png" as="image">
  <link rel="preload" href="./Champions_assets/Senna.png" as="image">
  <link rel="preload" href="./Champions_assets/Seraphine.png" as="image">
  <link rel="preload" href="./Champions_assets/Sett.png" as="image">
  <link rel="preload" href="./Champions_assets/Shaco.png" as="image">
  <link rel="preload" href="./Champions_assets/Shen.png" as="image">
  <link rel="preload" href="./Champions_assets/Shyvana.png" as="image">
  <link rel="preload" href="./Champions_assets/Singed.png" as="image">
  <link rel="preload" href="./Champions_assets/Sion.png" as="image">
  <link rel="preload" href="./Champions_assets/Sivir.png" as="image">
  <link rel="preload" href="./Champions_assets/Skarner.png" as="image">
  <link rel="preload" href="./Champions_assets/Smolder.png" as="image">
  <link rel="preload" href="./Champions_assets/Sona.png" as="image">
  <link rel="preload" href="./Champions_assets/Soraka.png" as="image">
  <link rel="preload" href="./Champions_assets/Swain.png" as="image">
  <link rel="preload" href="./Champions_assets/Sylas.png" as="image">
  <link rel="preload" href="./Champions_assets/Syndra.png" as="image">
  <link rel="preload" href="./Champions_assets/Tahm_Kench.png" as="image">
  <link rel="preload" href="./Champions_assets/Taliyah.png" as="image">
  <link rel="preload" href="./Champions_assets/Talon.png" as="image">
  <link rel="preload" href="./Champions_assets/Taric.png" as="image">
  <link rel="preload" href="./Champions_assets/Teemo.png" as="image">
  <link rel="preload" href="./Champions_assets/Thresh.png" as="image">
  <link rel="preload" href="./Champions_assets/Tristana.png" as="image">
  <link rel="preload" href="./Champions_assets/Trundle.png" as="image">
  <link rel="preload" href="./Champions_assets/Tryndamere.png" as="image">
  <link rel="preload" href="./Champions_assets/Twisted_Fate.png" as="image">
  <link rel="preload" href="./Champions_assets/Twitch.png" as="image">
  <link rel="preload" href="./Champions_assets/Udyr.png" as="image">
  <link rel="preload" href="./Champions_assets/Urgot.png" as="image">
  <link rel="preload" href="./Champions_assets/Varus.png" as="image">
  <link rel="preload" href="./Champions_assets/Vayne.png" as="image">
  <link rel="preload" href="./Champions_assets/Veigar.png" as="image">
  <link rel="preload" href="./Champions_assets/Vel'Koz.png" as="image">
  <link rel="preload" href="./Champions_assets/Vex.png" as="image">
  <link rel="preload" href="./Champions_assets/Vi.png" as="image">
  <link rel="preload" href="./Champions_assets/Viego.png" as="image">
  <link rel="preload" href="./Champions_assets/Viktor.png" as="image">
  <link rel="preload" href="./Champions_assets/Vladimir.png" as="image">
  <link rel="preload" href="./Champions_assets/Volibear.png" as="image">
  <link rel="preload" href="./Champions_assets/Warwick.png" as="image">
  <link rel="preload" href="./Champions_assets/Wukong.png" as="image">
  <link rel="preload" href="./Champions_assets/Xayah.png" as="image">
  <link rel="preload" href="./Champions_assets/Xerath.png" as="image">
  <link rel="preload" href="./Champions_assets/Xin_Zhao.png" as="image">
  <link rel="preload" href="./Champions_assets/Yasuo.png" as="image">
  <link rel="preload" href="./Champions_assets/Yone.png" as="image">
  <link rel="preload" href="./Champions_assets/Yorick.png" as="image">
  <link rel="preload" href="./Champions_assets/Yuumi.png" as="image">
  <link rel="preload" href="./Champions_assets/Zac.png" as="image">
  <link rel="preload" href="./Champions_assets/Zed.png" as="image">
  <link rel="preload" href="./Champions_assets/Zeri.png" as="image">
  <link rel="preload" href="./Champions_assets/Ziggs.png" as="image">
  <link rel="preload" href="./Champions_assets/Zilean.png" as="image">
  <link rel="preload" href="./Champions_assets/Zoe.png" as="image">
  <link rel="preload" href="./Champions_assets/Zyra.png" as="image">
</head>
<body>
  <!-- Indicador de estado -->
  <div class="status-indicator">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Ready</span>
  </div>

  <!-- Switch de idioma -->
  <div class="language-switch">
    <span class="lang-label active">🇺🇸 EN</span>
    <label class="switch">
      <input type="checkbox" id="langSwitch" />
      <span class="slider"></span>
    </label>
    <span class="lang-label">🇪🇸 ES</span>
  </div>

  <!-- Switch de tema -->
  <div class="language-switch" style="top: 70px;">
    <span class="lang-label active" data-translate="dark">🌙 Dark</span>
    <label class="switch">
      <input type="checkbox" id="themeSwitch" />
      <span class="slider"></span>
    </label>
    <span class="lang-label" data-translate="light">☀️ Light</span>
  </div>

  <!-- Icono de la aplicación -->
  <img src="./images/Flash.png" alt="Flash Icon" class="app-icon" onclick="createFlashSparkles(this)" style="cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1) rotate(5deg)'; this.style.filter='drop-shadow(0 0 15px #f39c12)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.filter='none'" />
  
  <!-- Título -->
  <h1>LoL Flash Tracker</h1>

  <!-- Formulario principal -->
  <div class="form-group" style="align-items: center; justify-content: center; min-height: 100vh;">
    <!-- Caja de invitado - elementos más usados -->
    <div class="guest-box" style="position: relative; align-self: flex-start;">
      <!-- Preview del nombre -->
      <div style="position: relative; margin-bottom: 8px;">
        <div id="userPreviewTop" style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; font-weight: bold;"></div>
        <div id="clickCounter" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-size: 0.6rem; color: var(--text-muted); opacity: 0.3;"></div>
      </div>
      <div class="nickname-container">
        <div style="position: relative;">
          <input type="text" 
                 id="nickname" 
                 placeholder="e.g: Ana" 
                 maxlength="20" 
                 autocomplete="off"
                 data-translate-placeholder="placeholder" 
                 list="recentNames" />
          <datalist id="recentNames"></datalist>

          <div class="error-message" id="nicknameError"></div>
        </div>

      </div>
      
      <!-- Panel de personalización -->
      <div id="customizePanel" style="position: relative; margin-top: 4px;">
        <!-- Botón customizar -->
        <button id="customizeBtn" style="width: 50%; padding: 6px 12px; background: var(--bg-tertiary); color: var(--text-primary); border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; margin: 0 auto 8px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; transition: all 0.3s ease; display: block;" data-translate="customize">🎨 Personalizar <span id="customizeArrow" style="transition: transform 0.3s ease;">▼</span></button>
        
        <!-- Contenido desplegable -->
        <div id="customizeContent" style="max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.6s ease, opacity 0.6s ease; padding: 0 8px;">
          <!-- Separador -->
          <div style="height: 1px; background: linear-gradient(90deg, transparent, var(--border), transparent); margin: 12px 0;"></div>
          
          <!-- Champion Icon -->
          <label style="font-size: 0.8rem; margin-bottom: 4px; display: block;">
            <span>✏️ <span data-translate="championIcon">Champion Icon:</span></span>
          </label>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <input type="text" id="championInput" placeholder="Type champion name..." data-translate-placeholder="championPlaceholder" style="flex: 1; padding: 6px 8px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.85rem;" list="championList" autocomplete="off">
            <datalist id="championList"></datalist>
            <img id="championPreview" style="width: 32px; height: 32px; border-radius: 4px; border: 1px solid var(--border); display: none; object-fit: cover; flex-shrink: 0;" />
            <button id="clearChampion" style="padding: 6px 10px; background: var(--bg-tertiary); color: var(--text-muted); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-size: 0.8rem; transition: transform 0.1s ease;" data-translate="none">None</button>
          </div>
          
          <!-- User Color -->
          <label style="font-size: 0.8rem; margin-bottom: 4px; display: block;">
            <span>🎨 <span data-translate="userColor">User Color:</span></span>
          </label>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <select id="userColor" style="flex: 0 0 140px; padding: 6px 8px; background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.85rem;">
              <option value="" data-translate="defaultColor">Default</option>
              <option value="custom" data-translate="customColor">Custom</option>
              <option value="#ff6b6b">🔴 Red</option>
              <option value="#4ecdc4">🟢 Green</option>
              <option value="#45b7d1">🔵 Blue</option>
              <option value="#f9ca24">🟡 Yellow</option>
              <option value="#f0932b">🟠 Orange</option>
              <option value="#eb4d4b">🔴 Crimson</option>
              <option value="#6c5ce7">🟣 Purple</option>
              <option value="#a29bfe">🟣 Lavender</option>
              <option value="#fd79a8">🥷 Pink</option>
              <option value="#00b894">🟢 Teal</option>
            </select>
            <input type="color" id="colorPicker" value="#bb86fc" style="width: 32px; height: 32px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; background: none;">
            <div id="colorPreview" style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid var(--border); background: var(--text-primary);"></div>
            <button id="clearColor" style="padding: 4px 8px; background: var(--bg-tertiary); color: var(--text-muted); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-size: 0.75rem; transition: transform 0.1s ease;" data-translate="none">None</button>
          </div>
          
          <!-- Separador -->
          <div style="height: 1px; background: linear-gradient(90deg, transparent, var(--border), transparent); margin: 12px 0;"></div>
          
          <!-- Botón randomizar -->
          <button id="randomizeAll" style="width: 100%; padding: 6px 12px; background: #f39c12; color: white; border: none; border-radius: var(--radius); cursor: pointer; margin-bottom: 8px; font-size: 0.8rem;" data-translate="randomAll">🎲 Random Champion + Color</button>
          
          <!-- Botón Clear All -->
          <button id="clearAll" style="width: 100%; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: var(--radius); cursor: pointer; margin-bottom: 8px; font-size: 0.8rem;" data-translate="clearAll">🧹 Clear All</button>
        </div>
      </div>

      <!-- Separador -->
      <div style="height: 1px; background: linear-gradient(90deg, transparent, var(--border), transparent); margin: 12px 0;"></div>

      <!-- Botón unirse -->
      <button id="joinRoomBtn" 
              class="action-button join" 
              aria-label="Join an existing room">
        <span>🔗</span> 
        <span data-translate="join">Join</span>
      </button>
      
      <!-- Botón jugar solo -->
      <button id="soloBtn" 
              class="action-button solo" 
              style="font-size: 0.8rem; padding: 8px 12px; margin-top: 8px;"
              aria-label="Play solo">
        <span>🎮</span> 
        <span data-translate="playSolo">Jugar solo</span>
      </button>
    </div>

    <!-- Botón crear sala -->
    <button id="createRoomBtn" 
            class="action-button host" 
            aria-label="Create a new room as host">
      <span>🎮</span> 
      <span data-translate="createRoom">Create room</span>
    </button>

    <!-- Separador visual -->
    <div class="section-separator"></div>

    <!-- Switch de modo -->
    <div class="mode-switch-container">
      <div class="switch-wrapper">
        <div class="switch-label">
          <span>🖥️</span> 
          <span data-translate="window">Window</span>
        </div>
        <label class="switch">
          <input type="checkbox" id="modeSwitch" aria-label="Switch between window and tab mode" />
          <span class="slider"></span>
        </label>
        <div class="switch-label">
          <span>🌐</span> 
          <span data-translate="tab">Tab</span>
        </div>
      </div>
    </div>

    <!-- Configuración avanzada -->
    <details class="advanced-settings" id="advancedSettings">
      <summary data-translate="advancedSettings">Advanced settings</summary>
      <button id="helpBtn" style="position: absolute; right: 16px; top: 12px; width: 22px; height: 22px; background: var(--bg-card); border: 2px solid var(--border); color: var(--text-muted); border-radius: 4px; font-size: 0.8rem; font-weight: bold; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.3s ease; opacity: 0.7; z-index: 10;">i</button>
      <div class="settings-panel">

        
        <label>
          <input type="checkbox" id="noSaveOptions"> 
          <span data-translate="noSaveOptions">Don't save my options</span>
        </label>
        <div style="position: relative; margin-bottom: 12px;">
          <div class="help-text" id="helpNoSave" style="display: none; font-size: 0.75rem; color: #7dd3fc; padding: 4px 0; margin-top: 4px; opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.4s ease, max-height 0.4s ease, padding 0.4s ease; font-family: 'Courier New', monospace;" data-translate="helpNoSave">Prevents saving any preferences locally. Everything resets when you close the app.</div>
        </div>
        
        <label>
          <input type="checkbox" id="autoFocus" checked> 
          <span data-translate="autoFocus">Auto-focus window</span>
        </label>
        <div style="position: relative; margin-bottom: 12px;">
          <div class="help-text" id="helpAutoFocus" style="display: none; font-size: 0.75rem; color: #7dd3fc; padding: 4px 0; margin-top: 4px; opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.4s ease, max-height 0.4s ease, padding 0.4s ease; font-family: 'Courier New', monospace;" data-translate="helpAutoFocus">Brings the new window to the front when opened (may be blocked by browser security).</div>
        </div>
        

        <label>
          <span data-translate="windowSize">Window size:</span>
          <select id="windowSize">
            <option value="small" data-translate="small">Small (500×700)</option>
            <option value="medium" selected data-translate="medium">Medium (500×800)</option>
            <option value="large" data-translate="large">Large (600×1080)</option>
          </select>
        </label>
        <div style="position: relative; margin-bottom: 12px;">
          <div class="help-text" id="helpWindowSize" style="display: none; font-size: 0.75rem; color: #7dd3fc; padding: 4px 0; margin-top: 4px; opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.4s ease, max-height 0.4s ease, padding 0.4s ease; font-family: 'Courier New', monospace;" data-translate="helpWindowSize">Sets the dimensions of the tracker window. Only applies to window mode, not tabs.</div>
        </div>
        
        <div style="height: 1px; background: linear-gradient(90deg, transparent, var(--border), transparent); margin: 20px 0;"></div>
        

        

        
        <button id="testDiana" style="width: 100%; padding: 8px 12px; background: #6c5ce7; color: white; border: none; border-radius: var(--radius); cursor: pointer; margin-top: 12px; font-size: 0.85rem;">🌙 Test Diana Easter Egg</button>
        
        <button id="clearAllData" style="width: 100%; padding: 8px 12px; background: var(--error); color: white; border: none; border-radius: var(--radius); cursor: pointer; margin-top: 8px; font-size: 0.85rem;" data-translate="clearAllData">Clear all data</button>
        <div style="position: relative;">
          <div class="help-text" id="helpClearData" style="display: none; font-size: 0.75rem; color: #7dd3fc; padding: 4px 0; margin-top: 4px; opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.4s ease, max-height 0.4s ease, padding 0.4s ease; font-family: 'Courier New', monospace;" data-translate="helpClearData">Removes all saved preferences, nicknames, and settings. Resets the app to first-time use.</div>
        </div>
      </div>
    </details>
    
    <!-- Version footer -->
    <div class="version-footer">
      Lol Spell Tracker v0.9.0 - 12/9/25 - Invite URL Testing - Share rooms with invite links
    </div>
  </div>

  <script>
    // ====================== TRADUCCIONES ======================
    const translations = {
      en: {
        ready: "Ready",
        yourName: "Your name",
        placeholder: "e.g: Champion",
        joinRoom: "Join / Solo",
        join: "Join",
        window: "Window",
        tab: "Tab",
        iAmHost: "I am the host",
        createRoom: "Create room",
        advancedSettings: "Advanced settings",
        rememberChoice: "Remember my role choice",
        autoFocus: "Auto-focus window",
        windowSize: "Window size:",
        small: "Small (450×725)",
        medium: "Medium (450×775)",
        large: "Large (550×900)",
        modeChanged: "Mode changed to:",
        nameRequired: "Name must be at least 2 characters",
        nameTooLong: "Name cannot be more than 20 characters",
        invalidChars: "Only letters, numbers and spaces allowed",
        windowOpened: "Window opened successfully!",
        tabOpened: "Tab opened as",
        host: "host",
        guest: "guest",
        windowError: "❌ Could not open window. Check popup blocker settings.",
        tabError: "❌ Could not open tab. Check browser settings.",
        readyToUse: "Ready to use",
        playSolo: "Play solo",
        dianaText: "A new moon is rising",
        followLunari: "Follow the Lunari",
        fightSolari: "Fight the Solari",
        dark: "Dark",
        light: "Light",
        clearAllData: "Clear all data",
        helpRemember: "Automatically selects your last used role (host/guest) when opening the app.",
        helpAutoFocus: "Brings the new window to the front when opened (may be blocked by browser security).",
        helpWindowSize: "Sets the dimensions of the tracker window. Only applies to window mode, not tabs.",
        helpClearData: "Removes all saved preferences, nicknames, and settings. Resets the app to first-time use.",
        championIcon: "Champion Icon",
        helpChampionIcon: "Set a champion icon for others to see.",
        userColor: "User Color",
        helpUserColor: "Choose a color for your name that others will see.",

        defaultColor: "Default",
        customColor: "Custom",
        championPlaceholder: "Type champion name...",
        none: "None",
        randomAll: "🎲 Random Champion + Color",
        clearAll: "🧹 Clear All",
        helpRandomAll: "Randomly selects a champion name, sets it as your nickname, and picks a random color.",
        helpClearAll: "Clears your nickname, champion icon, and color selection. Resets everything to default.",
        noSaveOptions: "Don't save my options",
        helpNoSave: "Prevents saving any preferences locally. Everything resets when you close the app.",
        customize: "Customize"
      },
      es: {
        ready: "Listo",
        yourName: "Tu nombre",
        placeholder: "Ej: Campeón",
        joinRoom: "Unirse / Solo",
        join: "Unirse",
        window: "Ventana",
        tab: "Pestaña",
        iAmHost: "Soy el anfitrión",
        createRoom: "Crear sala",
        advancedSettings: "Configuración avanzada",
        rememberChoice: "Recordar mi elección de rol",
        autoFocus: "Enfocar automáticamente la ventana",
        windowSize: "Tamaño de ventana:",
        small: "Pequeña (450×725)",
        medium: "Mediana (450×775)",
        large: "Grande (550×900)",
        modeChanged: "Modo cambiado a:",
        nameRequired: "El nombre debe tener al menos 2 caracteres",
        nameTooLong: "El nombre no puede tener más de 20 caracteres",
        invalidChars: "Solo se permiten letras, números y espacios",
        windowOpened: "¡Ventana abierta correctamente!",
        tabOpened: "¡Pestaña abierta como",
        host: "anfitrión",
        guest: "invitado",
        windowError: "❌ No se pudo abrir la ventana. Verifica que no estén bloqueadas las ventanas emergentes.",
        tabError: "❌ No se pudo abrir la pestaña. Verifica la configuración del navegador.",
        readyToUse: "Listo para usar",
        playSolo: "Jugar solo",
        dianaText: "Una nueva luna se alza",
        followLunari: "Sigue a los Lunari",
        fightSolari: "Lucha contra los Solari",
        dark: "Oscuro",
        light: "Claro",
        clearAllData: "Limpiar todos los datos",
        helpRemember: "Selecciona automáticamente tu último rol usado (anfitrión/invitado) al abrir la app.",
        helpAutoFocus: "Trae la nueva ventana al frente al abrirse (puede ser bloqueado por seguridad del navegador).",
        helpWindowSize: "Establece las dimensiones de la ventana del tracker. Solo aplica al modo ventana, no pestañas.",
        helpClearData: "Elimina todas las preferencias, nombres y configuraciones guardadas. Resetea la app como si fuera la primera vez.",
        championIcon: "Icono de Campeón",
        helpChampionIcon: "Establece un icono de campeón para que lo vean los demás.",
        userColor: "Color de Usuario",
        helpUserColor: "Elige un color para tu nombre que verán los demás.",

        defaultColor: "Por defecto",
        customColor: "Personalizado",
        championPlaceholder: "Escribe nombre del campeón...",
        none: "Ninguno",
        randomAll: "🎲 Campeón + Color Aleatorio",
        clearAll: "🧹 Limpiar Todo",
        helpRandomAll: "Selecciona aleatoriamente un nombre de campeón, lo establece como tu apodo y elige un color aleatorio.",
        helpClearAll: "Limpia tu apodo, icono de campeón y selección de color. Resetea todo a los valores por defecto.",
        noSaveOptions: "No guardar mis opciones",
        helpNoSave: "Evita guardar cualquier preferencia localmente. Todo se resetea al cerrar la aplicación.",
        customize: "Personalizar"
      }
    };

    let currentLang = ConfigManager.getLanguage();

    // ====================== VARIABLES GLOBALES ======================
    // Champions list moved to ChampionManager.js

    let dianaEffectsActive = false;
    let dianaPulseInterval = null;
    let originalJoinText = '';
    let originalSoloText = '';
    let originalCreateText = '';
    let clickCount = 0;
    let clickTimer = null;
    
    // Customize button effects
    function setupCustomizeButton() {
      const btn = document.getElementById('customizeBtn');
      const content = document.getElementById('customizeContent');
      const arrow = document.getElementById('customizeArrow');
      if (!btn || !content) return;
      
      const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe', '#fd79a8', '#00b894'];
      let isExpanded = false;
      
      btn.addEventListener('click', () => {
        // Efectos de chispas aleatorias
        createSparkles(btn);
        
        isExpanded = !isExpanded;
        if (isExpanded) {
          content.style.maxHeight = '400px';
          content.style.opacity = '1';
          if (arrow) arrow.style.transform = 'rotate(180deg)';
        } else {
          content.style.maxHeight = '0';
          content.style.opacity = '0';
          if (arrow) arrow.style.transform = 'rotate(0deg)';
        }
      });
      
      function createSparkles(button) {
        const sparkleCount = Math.floor(Math.random() * 6) + 4;
        const sparkles = ['✨', '⭐', '💫', '🌟', '✦', '✧'];
        
        for (let i = 0; i < sparkleCount; i++) {
          const sparkle = document.createElement('div');
          sparkle.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
          sparkle.style.cssText = `
            position: absolute;
            pointer-events: none;
            font-size: ${Math.random() * 0.5 + 0.5}rem;
            left: ${Math.random() * 100}%;
            top: ${Math.random() * 100}%;
            animation: sparkleFloat ${Math.random() * 1 + 1}s ease-out forwards;
            z-index: 1000;
          `;
          
          button.parentElement.appendChild(sparkle);
          
          setTimeout(() => sparkle.remove(), 2000);
        }
      }
      
      btn.addEventListener('mouseenter', () => {
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        const randomBg = colors[Math.floor(Math.random() * colors.length)];
        btn.style.borderColor = randomColor;
        btn.style.backgroundColor = randomBg;
        btn.style.boxShadow = `0 0 15px ${randomColor}80`;
      });
      
      btn.addEventListener('mouseleave', () => {
        btn.style.borderColor = 'var(--border)';
        btn.style.backgroundColor = 'var(--bg-tertiary)';
        btn.style.boxShadow = 'none';
      });
      
      btn.addEventListener('mousedown', () => {
        btn.style.transform = 'scale(0.95)';
      });
      
      btn.addEventListener('mouseup', () => {
        btn.style.transform = 'scale(1)';
      });
    }


    const elements = {
      nicknameInput: document.getElementById('nickname'),
      createRoomBtn: document.getElementById('createRoomBtn'),
      joinRoomBtn: document.getElementById('joinRoomBtn'),
      soloBtn: document.getElementById('soloBtn'),

      modeSwitch: document.getElementById('modeSwitch'),
      statusDot: document.getElementById('statusDot'),
      statusText: document.getElementById('statusText'),
      nicknameError: document.getElementById('nicknameError'),

      autoFocus: document.getElementById('autoFocus'),
      windowSize: document.getElementById('windowSize'),
      langSwitch: document.getElementById('langSwitch'),
      themeSwitch: document.getElementById('themeSwitch')
    };

    let isTabMode = false;
    let recentNicknames = JSON.parse(localStorage.getItem('lol-tracker-recent-names') || '[]');



    // ====================== FUNCIONES DE TRADUCCIÓN ======================
    function t(key) {
      return translations[currentLang][key] || key;
    }

    function getRandomChampion() {
      return ChampionManager.getRandomChampion();
    }

    function updateTexts() {
      document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        el.textContent = t(key);
      });

      document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
        const key = el.getAttribute('data-translate-placeholder');
        el.placeholder = t(key);
      });

      elements.nicknameInput.placeholder = `${currentLang === 'es' ? 'Ej' : 'e.g'}: ${getRandomChampion()}`;
      elements.statusText.textContent = t("ready");
      
      const langLabels = document.querySelectorAll(".lang-label");
      langLabels[0].classList.toggle("active", currentLang === "en");
      langLabels[1].classList.toggle("active", currentLang === "es");
      
      updateThemeLabels();
    }

    function updateThemeLabels() {
      const themeLabels = document.querySelectorAll(".language-switch")[1].querySelectorAll(".lang-label");
      const isLight = document.body.classList.contains('light-theme');
      themeLabels[0].classList.toggle("active", !isLight);
      themeLabels[1].classList.toggle("active", isLight);
      themeLabels[0].innerHTML = `🌙 ${t('dark')}`;
      themeLabels[1].innerHTML = `☀️ ${t('light')}`;
    }

    function switchLanguage() {
      currentLang = currentLang === "en" ? "es" : "en";
      if (!ConfigManager.isNoSaveMode()) {
        ConfigManager.setLanguage(currentLang);
      }
      elements.langSwitch.checked = currentLang === "es";
      updateTexts();
      showToast(t("modeChanged") + " " + (currentLang === "en" ? "English" : "Español"), "info", 2000);
    }

    // ====================== UTILIDADES ======================
    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    function showError(message) {
      elements.nicknameError.textContent = message;
      elements.nicknameError.classList.add('show');
      elements.nicknameInput.classList.add('error');
      
      setTimeout(() => {
        elements.nicknameError.classList.remove('show');
        elements.nicknameInput.classList.remove('error');
      }, 3000);
    }

    function updateStatus(status, type = 'success') {
      elements.statusText.textContent = status;
      elements.statusDot.className = `status-dot ${type}`;
    }

    // ====================== VALIDACIÓN ======================
    function validateNicknameRealTime(nickname) {
      return ValidationManager.validateRealTime(nickname, elements.nicknameInput);
    }

    function validateNickname(nickname, isUsingRandomName = false) {
      // Skip all validations during Diana easter egg
      if (dianaEffectsActive && (nickname === 'Diana, Scorn of the Moon' || nickname === 'Diana, El desdén de la Luna')) {
        return true;
      }
      
      if (!nickname || nickname.trim().length < 2) {
        showError(t("nameRequired"));
        return false;
      }
      
      if (nickname.trim().length > 20) {
        showError(t("nameTooLong"));
        return false;
      }
      
      if (!/^[a-zA-Z0-9\sáéíóúñüÁÉÍÓÚÑÜ.'&]+$/.test(nickname.trim())) {
        showError(t("invalidChars"));
        return false;
      }
      
      // Skip champion name validation if using random name from placeholder
      if (isUsingRandomName) {
        return true;
      }
      
      // Check if nickname is a champion name (only when champion icon is selected)
      const selectedChampion = localStorage.getItem(CONFIG.STORAGE_KEYS.SELECTED_CHAMPION);
      const isChampionName = ChampionManager.validateChampionName(nickname.trim());
      
      if (isChampionName && selectedChampion && selectedChampion.toLowerCase() !== nickname.trim().toLowerCase()) {
        showError(currentLang === 'es' ? 'No puedes usar nombres de campeones como tu nombre' : 'You cannot use champion names as your nickname');
        return false;
      }
      
      return true;
    }

    // ====================== GESTIÓN DE ROLES ======================
    function selectRole(role) {
      const isHost = role === 'host';
      
      // Simplemente guardar el rol seleccionado
      

      
      updateRoleUI();
    }

    function updateRoleUI() {
      // Ya no necesitamos cambiar la UI, todos los botones están visibles
    }

    // ====================== GESTIÓN DE VENTANAS ======================
    function getWindowSize() {
      const size = elements.windowSize.value;
      return CONFIG.WINDOW_SIZES[size] || CONFIG.WINDOW_SIZES.medium;
    }

    function abrirEnVentana(url) {
      const { width, height } = getWindowSize();
      const opciones = `width=${width},height=${height},resizable=yes,scrollbars=no,titlebar=no,toolbar=no,location=no,status=no`;

      const uniqueName = `LoLFlashTracker_${Date.now()}`;
      const ventana = window.open(url, uniqueName, opciones);
      
      if (ventana) {
        if (elements.autoFocus.checked) {
          ventana.focus();
        }
        showToast(t('windowOpened'), 'success');
        updateStatus('Window open', 'success');
      } else {
        showToast(t('windowError'), 'error', 5000);
        updateStatus('Error opening window', 'error');
      }
    }

    // ====================== MANEJADORES DE EVENTOS ======================
    function handleKeyDown(event, role) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        selectRole(role);
      }
    }

    function launchApp(role) {
      let nickname = elements.nicknameInput.value.trim();
      // Obtener campeón actual del DOM, no del localStorage
      const championInput = document.getElementById('championInput');
      const selectedChampion = championInput.value.trim() || null;
      let isUsingRandomName = false;
      
      // Si hay campeón seleccionado pero no hay nombre, mostrar error
      if (selectedChampion && !nickname) {
        showError(currentLang === 'es' ? 'Debes introducir un nombre cuando seleccionas un campeón' : 'You must enter a name when selecting a champion');
        return;
      }
      
      // Si no hay nombre y no hay campeón, usar el del placeholder
      if (!nickname && !selectedChampion) {
        const placeholder = elements.nicknameInput.placeholder;
        const match = placeholder.match(/: (.+)/);
        nickname = match ? match[1] : 'Player';
        isUsingRandomName = true;
      }
      
      if (!validateNickname(nickname, isUsingRandomName)) {
        return;
      }
      
      addToRecentNames(nickname);

      // Obtener color actual del DOM
      let currentColor = null;
      if (dianaEffectsActive) {
        currentColor = 'linear-gradient(45deg, #ffffff, #87ceeb)';
      } else {
        const colorSelect = document.getElementById('userColor');
        const colorPicker = document.getElementById('colorPicker');
        if (colorSelect.value && colorSelect.value !== 'custom') {
          currentColor = colorSelect.value;
        } else if (colorSelect.value === 'custom') {
          currentColor = colorPicker.value;
        }
      }
      
      // Usar sessionStorage para transferir datos entre ventanas
      const config = {
        nick: nickname,
        role: role,
        theme: document.body.classList.contains('light-theme') ? 'light' : 'dark',
        lang: currentLang,
        diana: dianaEffectsActive,
        champion: dianaEffectsActive ? 'Diana' : selectedChampion,
        color: currentColor
      };
      
      sessionStorage.setItem('lol-tracker-launch-config', JSON.stringify(config));
      
      const url = 'lol-spell-tracker.html';
      
      if (isTabMode) {
        const newTab = window.open(url, '_blank');
        if (newTab) {
          showToast(`${t('tabOpened')} ${role === 'host' ? t('host') : t('guest')}!`, 'success');
          updateStatus('Tab open', 'success');
        } else {
          showToast(t('tabError'), 'error');
          updateStatus('Error opening tab', 'error');
        }
      } else {
        abrirEnVentana(url);
      }
    }
    
    function addToRecentNames(name) {
      if (!name || name.length < 2) return;
      
      // No añadir nombres de campeones o Diana a las sugerencias
      const isChampionName = ChampionManager.validateChampionName(name);
      const isDianaName = name === 'Diana, Scorn of the Moon' || name === 'Diana, El desdén de la Luna';
      if (isChampionName || isDianaName) return;
      
      recentNicknames = recentNicknames.filter(n => n.toLowerCase() !== name.toLowerCase());
      recentNicknames.unshift(name);
      recentNicknames = recentNicknames.slice(0, 10);
      localStorage.setItem('lol-tracker-recent-names', JSON.stringify(recentNicknames));
      updateDatalist();
    }
    
    function updateDatalist() {
      const datalist = document.getElementById('recentNames');
      datalist.innerHTML = '';
      recentNicknames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
      });
    }
    


    // ====================== INICIALIZACIÓN ======================
    function loadSettings() {
      const savedNick = localStorage.getItem('lol-tracker-nickname');
      if (savedNick) {
        elements.nicknameInput.value = savedNick;
      }

      const savedMode = localStorage.getItem('lol-tracker-mode') === 'tab';
      elements.modeSwitch.checked = savedMode;
      isTabMode = savedMode;



      const autoFocus = localStorage.getItem('auto-focus') !== 'false';
      elements.autoFocus.checked = autoFocus;

      const windowSize = localStorage.getItem('window-size') || 'medium';
      elements.windowSize.value = windowSize;

      elements.langSwitch.checked = currentLang === "es";
      
      const savedUserColor = localStorage.getItem('user-color');
      if (savedUserColor) {
        // Check if it's a preset color
        const isPresetColor = document.querySelector(`#userColor option[value="${savedUserColor}"]`);
        if (isPresetColor) {
          document.getElementById('userColor').value = savedUserColor;
        } else {
          document.getElementById('colorPicker').value = savedUserColor;
        }
        document.getElementById('colorPreview').style.background = savedUserColor;
      }
      
      // Cargar estado de "No guardar mis opciones"
      const noSaveOptions = localStorage.getItem('no-save-options') === 'true';
      document.getElementById('noSaveOptions').checked = noSaveOptions;
      

      

      

      
      const savedTheme = ConfigManager.getTheme();
      
      ConfigManager.applyTheme(savedTheme);
      elements.themeSwitch.checked = savedTheme === 'light';
      
      updateTexts();
      updateDatalist();
    }

    function setupEventListeners() {
      elements.nicknameInput.addEventListener('input', (e) => {
        const nickname = e.target.value;
        
        // Real-time validation
        validateNicknameRealTime(nickname);
        
        // Update preview when typing (unless Diana is active)
        if (!dianaEffectsActive) {
          updatePreview();
        }
        
        // Clear error messages
        elements.nicknameError.classList.remove('show');
        
        // Desactivar Diana easter egg si se escribe un nombre diferente
        const isDianaName = nickname === 'Diana, Scorn of the Moon' || nickname === 'Diana, El desdén de la Luna';
        if (dianaEffectsActive && !isDianaName) {
          // Desactivar easter egg
          dianaEffectsActive = false;
          document.body.classList.remove('diana-mode');
          
          // Restaurar elementos
          const appIcon = document.querySelector('.app-icon');
          const title = document.querySelector('h1');
          const joinBtn = document.getElementById('joinRoomBtn');
          const soloBtn = document.getElementById('soloBtn');
          const createBtn = document.getElementById('createRoomBtn');
          
          if (dianaPulseInterval) {
            clearInterval(dianaPulseInterval);
            dianaPulseInterval = null;
          }
          
          appIcon.src = './images/Flash.png';
          title.textContent = 'LoL Flash Tracker';
          joinBtn.innerHTML = originalJoinText;
          soloBtn.innerHTML = originalSoloText;
          createBtn.innerHTML = originalCreateText;
          
          // Restaurar favicon
          const favicon = document.querySelector('link[rel="icon"]');
          favicon.href = './images/Flash.png';
          
          // Limpiar configuraciones temporales de Diana
          window.tempDianaColor = null;
          window.tempDianaChampion = null;
        }
      });
      


      elements.nicknameInput.addEventListener('blur', (e) => {
        const val = e.target.value.trim();
        const isDianaName = val === 'Diana, Scorn of the Moon' || val === 'Diana, El desdén de la Luna';
        const noSaveElement = document.getElementById('noSaveOptions');
        const noSaveActive = noSaveElement ? noSaveElement.checked : false;
        if (val && !dianaEffectsActive && !isDianaName && !noSaveActive) {
          localStorage.setItem('lol-tracker-nickname', val);
        }
      });
      
      elements.nicknameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          launchApp('join'); // Por defecto join al presionar Enter
        }
      });

      elements.modeSwitch.addEventListener('change', () => {
        isTabMode = elements.modeSwitch.checked;
        localStorage.setItem('lol-tracker-mode', isTabMode ? 'tab' : 'window');
        showToast(`${t('modeChanged')} ${isTabMode ? t('tab') : t('window')}`, 'info', 2000);
      });

      elements.langSwitch.addEventListener('change', () => {
        switchLanguage();
        
        // Actualizar texto Diana si está activo
        if (dianaEffectsActive) {
          const title = document.querySelector('h1');
          const joinBtn = document.getElementById('joinRoomBtn');
          const soloBtn = document.getElementById('soloBtn');
          
          title.innerHTML = `<span style="filter: grayscale(1) brightness(2);">🌙</span> ${t('dianaText')} <span style="filter: grayscale(1) brightness(2);">🌙</span>`;
          joinBtn.innerHTML = `<span>🌙</span> <span>${t('followLunari')}</span>`;
          soloBtn.innerHTML = `<span>⚔️</span> <span>${t('fightSolari')}</span>`;
        }
      });
      
      elements.themeSwitch.addEventListener('change', () => {
        document.body.classList.toggle('light-theme', elements.themeSwitch.checked);
        if (ConfigManager.isNoSaveMode()) {
          // No guardar nada
        } else {
          ConfigManager.setTheme(elements.themeSwitch.checked ? 'light' : 'dark');
        }
        updateThemeLabels();
      });
      
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        const savedTheme = ConfigManager.getTheme();
        if (savedTheme === 'auto') {
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          elements.themeSwitch.checked = !prefersDark;
          document.body.classList.toggle('light-theme', !prefersDark);
          updateThemeLabels();
        }
      });

      // Event delegation para botones
      document.addEventListener('click', (e) => {
        if (e.target.closest('#createRoomBtn')) {
          launchApp('host');
        }
        if (e.target.closest('#joinRoomBtn')) {
          launchApp('join');
        }
        if (e.target.closest('#soloBtn')) {
          launchApp('solo');
        }


      });

      // Event delegation para configuración
      document.addEventListener('change', (e) => {
        if (e.target.matches('#noSaveOptions')) {
          const noSave = e.target.checked;
          const rememberChoice = document.getElementById('rememberChoice');
          const rememberLabel = document.getElementById('rememberChoiceLabel');
          
          if (noSave) {
            // Limpiar datos guardados excepto esta opción
            const currentNoSave = localStorage.getItem('no-save-options');
            localStorage.clear();
            localStorage.setItem('no-save-options', 'true');
          } else {
            localStorage.removeItem('no-save-options');
          }
        }
        
        // Solo guardar si "No guardar mis opciones" está desactivado
        const noSaveElement = document.getElementById('noSaveOptions');
        const noSaveActive = noSaveElement ? noSaveElement.checked : false;
        

        if (e.target.matches('#autoFocus') && !noSaveActive) {
          localStorage.setItem('auto-focus', e.target.checked);
        }
        if (e.target.matches('#windowSize') && !noSaveActive) {
          localStorage.setItem('window-size', e.target.value);
        }
      });

      // Champion Icon functionality
      const championInput = document.getElementById('championInput');
      const championList = document.getElementById('championList');
      const championPreview = document.getElementById('championPreview');
      const clearChampion = document.getElementById('clearChampion');

      function updateChampionList(filter = '') {
        championList.innerHTML = '';
        const filtered = ChampionManager.filterChampions(filter);
        
        filtered.forEach(champ => {
          const option = document.createElement('option');
          option.value = champ;
          championList.appendChild(option);
        });
      }

      // Function moved to ChampionManager.js

      function updateChampionPreview(championName) {
        const championButton = document.getElementById('championButton');
        
        if (championName && ChampionManager.validateChampionName(championName)) {
          const fileName = ChampionManager.getChampionFileName(championName);
          const fullPath = `./Champions_assets/${fileName}.png`;
          
          championPreview.src = fullPath;
          championPreview.style.display = 'block';
          

          
          // Update placeholder when champion is selected
          elements.nicknameInput.placeholder = currentLang === 'es' ? 'Introduce un nombre' : 'Set a name';
          
          // Clear username if it's a different champion name
          const currentName = elements.nicknameInput.value.trim();
          const isChampionName = ChampionManager.validateChampionName(currentName);
          if (isChampionName && currentName.toLowerCase() !== championName.toLowerCase()) {
            elements.nicknameInput.value = '';
          }
          
          const noSaveElement = document.getElementById('noSaveOptions');
          const noSaveActive = noSaveElement ? noSaveElement.checked : false;
          if (!dianaEffectsActive && !noSaveActive) {
            localStorage.setItem('selected-champion', championName);
          }
        } else {
          championPreview.style.display = 'none';
          championPreview.src = '';
          

          
          // Restore original placeholder
          elements.nicknameInput.placeholder = `${currentLang === 'es' ? 'Ej' : 'e.g'}: ${getRandomChampion()}`;
          
          const noSaveElement = document.getElementById('noSaveOptions');
          const noSaveActive = noSaveElement ? noSaveElement.checked : false;
          if (!noSaveActive) {
            localStorage.removeItem('selected-champion');
          }
        }
      }

      championInput.addEventListener('input', (e) => {
        const value = e.target.value;
        updateChampionList(value);
        
        const exactMatch = ChampionManager.champions.find(champ => 
          champ.toLowerCase() === value.toLowerCase()
        );
        
        // Don't save anything during easter egg
        if (dianaEffectsActive) {
          return;
        }
        
        updateChampionPreview(exactMatch);
      });

      clearChampion.addEventListener('click', () => {
        clearChampion.style.transform = 'scale(0.95)';
        setTimeout(() => {
          clearChampion.style.transform = 'scale(1)';
        }, 100);
        championInput.value = '';
        updateChampionPreview('');
        updateChampionList();
        updatePreview();
      });

      // Load saved champion
      const savedChampion = localStorage.getItem('selected-champion');
      if (savedChampion) {
        championInput.value = savedChampion;
        updateChampionPreview(savedChampion);
      }
      updateChampionList();
      
      // User Color functionality
      const userColorSelect = document.getElementById('userColor');
      const colorPreview = document.getElementById('colorPreview');
      
      function updateColorPreview(color) {
        if (color) {
          colorPreview.style.background = color;
        } else {
          colorPreview.style.background = 'var(--text-primary)';
        }
      }
      
      const colorPicker = document.getElementById('colorPicker');
      
      userColorSelect.addEventListener('change', (e) => {
        const selectedColor = e.target.value;
        const noSaveActive = document.getElementById('noSaveOptions').checked;
        updateColorPreview(selectedColor);
        if (selectedColor && !noSaveActive) {
          localStorage.setItem('user-color', selectedColor);
          colorPicker.value = '#bb86fc'; // Reset color picker
        } else if (!noSaveActive) {
          localStorage.removeItem('user-color');
        }
        updatePreview();
      });
      
      colorPicker.addEventListener('input', (e) => {
        const selectedColor = e.target.value;
        const noSaveActive = document.getElementById('noSaveOptions').checked;
        updateColorPreview(selectedColor);
        if (!dianaEffectsActive && !noSaveActive) {
          localStorage.setItem('user-color', selectedColor);
        }
        userColorSelect.value = 'custom'; // Mostrar Custom
        updatePreview();
      });
      
      const clearColorBtn = document.getElementById('clearColor');
      clearColorBtn.addEventListener('click', () => {
        clearColorBtn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          clearColorBtn.style.transform = 'scale(1)';
        }, 100);
        
        userColorSelect.value = '';
        colorPicker.value = '#bb86fc';
        updateColorPreview('');
        const noSaveActive = document.getElementById('noSaveOptions').checked;
        if (!noSaveActive) {
          localStorage.removeItem('user-color');
        }
        updatePreview();
      });
      

      
      // User Preview functionality
      function updatePreview() {
        const previewContainer = document.getElementById('userPreview');
        const previewTop = document.getElementById('userPreviewTop');
        
        // Get current name or placeholder
        let displayName = elements.nicknameInput.value.trim();
        if (!displayName) {
          const placeholder = elements.nicknameInput.placeholder;
          const match = placeholder.match(/: (.+)/);
          displayName = match ? match[1] : 'Player';
        }
        
        // Override with Diana name during easter egg
        if (dianaEffectsActive) {
          displayName = currentLang === 'es' ? 'Diana, El desdén de la Luna' : 'Diana, Scorn of the Moon';
        }
        
        // Get current champion and color (use temporary Diana settings if active)
        const championInput = document.getElementById('championInput');
        const selectedChampion = dianaEffectsActive ? 'Diana' : 
          (championInput.value.trim() || localStorage.getItem('selected-champion'));
        let selectedColor;
        if (dianaEffectsActive) {
          selectedColor = 'linear-gradient(45deg, #ffffff, #87ceeb)';
        } else {
          // Obtener color del selector o del color picker
          const colorSelect = document.getElementById('userColor');
          const colorPicker = document.getElementById('colorPicker');
          const noSaveElement = document.getElementById('noSaveOptions');
          const noSaveActive = noSaveElement ? noSaveElement.checked : false;
          
          if (colorSelect.value && colorSelect.value !== 'custom') {
            selectedColor = colorSelect.value;
          } else if (colorSelect.value === 'custom') {
            selectedColor = colorPicker.value;
          } else if (!noSaveActive) {
            selectedColor = localStorage.getItem('user-color');
          }
        }
        
        // Update both previews
        [previewContainer, previewTop].forEach(container => {
          if (!container) return;
          
          // Clear previous content
          container.innerHTML = '';
          
          // Add champion icon if selected
          if (selectedChampion) {
            const fileName = ChampionManager.getChampionFileName(selectedChampion);
            const championImg = document.createElement('img');
            championImg.src = `./Champions_assets/${fileName}.png`;
            championImg.style.cssText = container === previewTop ? 
              'width: 32px; height: 32px; border-radius: 4px; object-fit: cover;' :
              'width: 16px; height: 16px; border-radius: 2px; object-fit: cover;';
            championImg.onerror = () => championImg.style.display = 'none';
            container.appendChild(championImg);
          }
          
          // Add name with color
          const nameSpan = document.createElement('span');
          nameSpan.textContent = displayName;
          if (selectedColor && selectedColor.startsWith('linear-gradient')) {
            nameSpan.style.background = selectedColor;
            nameSpan.style.webkitBackgroundClip = 'text';
            nameSpan.style.webkitTextFillColor = 'transparent';
            nameSpan.style.backgroundClip = 'text';
            nameSpan.style.display = 'inline-block';
          } else {
            nameSpan.style.color = selectedColor || 'var(--text-primary)';
          }
          container.appendChild(nameSpan);
        });
      }
      
      // Update preview on changes
      userColorSelect.addEventListener('change', updatePreview);
      championInput.addEventListener('input', updatePreview);
      
      // Initial preview update
      updatePreview();

      document.getElementById('randomizeAll').addEventListener('click', (e) => {
        const btn = e.target;
        btn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          btn.style.transform = 'scale(1)';
        }, 100);
        
        // Contador de clicks
        clickCount++;
        
        if (clickTimer) {
          clearTimeout(clickTimer);
        }
        
        clickTimer = setTimeout(() => {
          clickCount = 0;
          const counter = document.getElementById('clickCounter');
          if (counter) counter.style.opacity = '0.3';
        }, 1000);
        
        if (clickCount > 5) {
          const counter = document.getElementById('clickCounter');
          if (counter) {
            counter.textContent = `x${clickCount}`;
            counter.style.opacity = '0.5';
          }
        }
        

        
        // Desactivar Diana easter egg si está activo
        if (dianaEffectsActive) {
          dianaEffectsActive = false;
          document.body.classList.remove('diana-mode');
          
          // Restaurar elementos
          const appIcon = document.querySelector('.app-icon');
          const title = document.querySelector('h1');
          const joinBtn = document.getElementById('joinRoomBtn');
          const soloBtn = document.getElementById('soloBtn');
          const createBtn = document.getElementById('createRoomBtn');
          
          if (dianaPulseInterval) {
            clearInterval(dianaPulseInterval);
            dianaPulseInterval = null;
          }
          
          appIcon.src = './images/Flash.png';
          title.textContent = 'LoL Flash Tracker';
          joinBtn.innerHTML = originalJoinText;
          soloBtn.innerHTML = originalSoloText;
          createBtn.innerHTML = originalCreateText;
          
          // Restaurar favicon
          const favicon = document.querySelector('link[rel="icon"]');
          favicon.href = './images/Flash.png';
          
          // Limpiar configuraciones temporales de Diana
          window.tempDianaColor = null;
          window.tempDianaChampion = null;
        }
        
        // Random champion
        let randomChampion = getRandomChampion();
        
        // 50% de probabilidad de cambiar Diana por otro campeón
        if (randomChampion.toLowerCase() === 'diana' && Math.random() < 0.5) {
          randomChampion = getRandomChampion();
        }
        
        // Si es Diana y tema oscuro, activar easter egg
        if (randomChampion.toLowerCase() === 'diana' && !document.body.classList.contains('light-theme')) {
          dianaEffectsActive = true;
          
          // Deshabilitar botón por 5 segundos
          btn.disabled = true;
          btn.style.opacity = '0.5';
          btn.style.cursor = 'not-allowed';
          setTimeout(() => {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
          }, 5000);
          
          const dianaName = currentLang === 'es' ? 'Diana, El desdén de la Luna' : 'Diana, Scorn of the Moon';
          elements.nicknameInput.value = dianaName;
          
          // Activar fondo Diana
          document.body.classList.add('diana-mode');
          
          // Set Diana champion icon (temporal, no guardar)
          championInput.value = 'Diana';
          const championPreview = document.getElementById('championPreview');
          championPreview.src = './Champions_assets/Diana.png';
          championPreview.style.display = 'block';
          
          // Set Diana gradient color (temporal, no guardar)
          document.getElementById('userColor').value = '';
          document.getElementById('colorPicker').value = '#87ceeb';
          document.getElementById('colorPreview').style.background = 'linear-gradient(45deg, #ffffff, #87ceeb)';
          
          // NO guardar datos de Diana para evitar problemas al recargar
          localStorage.removeItem('selected-champion');
          localStorage.removeItem('lol-tracker-nickname');
          localStorage.removeItem('user-color');
          
          // Sonido
          const audio = new Audio('./sound/Diana_Select.ogg');
          audio.volume = 0.5;
          audio.play().catch(e => console.log('Audio blocked:', e));
          
          // Cambiar botones
          const joinBtn = document.getElementById('joinRoomBtn');
          const soloBtn = document.getElementById('soloBtn');
          const createBtn = document.getElementById('createRoomBtn');
          originalJoinText = joinBtn.innerHTML;
          originalSoloText = soloBtn.innerHTML;
          originalCreateText = createBtn.innerHTML;
          
          joinBtn.innerHTML = `<span>🌙</span> <span>${t('followLunari')}</span>`;
          soloBtn.innerHTML = `<span>⚔️</span> <span>${t('fightSolari')}</span>`;
          createBtn.innerHTML = `<span>🌙</span> <span>Reveal the Truth</span>`;
          joinBtn.style.background = 'linear-gradient(45deg, #1e3a8a, #3730a3)';
          soloBtn.style.background = 'linear-gradient(45deg, #374151, #1f2937)';
          createBtn.style.background = 'linear-gradient(45deg, #0f172a, #1e293b)';
          createBtn.style.border = '2px solid #e5e7eb';
          joinBtn.style.boxShadow = '0 0 15px rgba(30, 58, 138, 0.5)';
          soloBtn.style.boxShadow = '0 0 15px rgba(55, 65, 81, 0.5)';
          createBtn.style.boxShadow = '0 0 15px rgba(15, 23, 42, 0.7)';
          
          // Cambiar icono y título
          const appIcon = document.querySelector('.app-icon');
          const title = document.querySelector('h1');
          
          title.style.opacity = '0';
          title.style.transform = 'translateY(-20px)';
          appIcon.style.transform = 'scale(0.8) rotate(-10deg)';
          
          setTimeout(() => {
            appIcon.src = './Champions_assets/Diana.png';
            title.innerHTML = `<span style="filter: grayscale(1) brightness(2);">🌙</span> ${t('dianaText')} <span style="filter: grayscale(1) brightness(2);">🌙</span>`;
            title.style.opacity = '1';
            title.style.transform = 'translateY(0) scale(1)';
            appIcon.style.transform = 'scale(1.1) rotate(5deg)';
            
            // Cambiar favicon
            const favicon = document.querySelector('link[rel="icon"]');
            favicon.href = './Champions_assets/Diana.png';
            
            // Update preview with Diana icon and gradient
            updatePreview();
            
            // Iniciar pulsaciones cada 2 segundos
            dianaPulseInterval = setInterval(() => {
              title.style.transform = 'translateY(0) scale(1.15)';
              appIcon.style.transform = 'scale(1.15) rotate(5deg)';
              
              setTimeout(() => {
                title.style.transform = 'translateY(0) scale(1)';
                appIcon.style.transform = 'scale(1.1) rotate(5deg)';
              }, 300);
            }, 2000);
          }, 200);
          
          return; // Salir temprano si es Diana
        }
        
        championInput.value = randomChampion;
        updateChampionPreview(randomChampion);
        
        // Set champion name as nickname
        elements.nicknameInput.value = randomChampion;
        
        // Random color
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe', '#fd79a8', '#00b894'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        
        // Guardar solo si no está activo "No guardar mis opciones"
        const noSaveElement = document.getElementById('noSaveOptions');
        const noSaveActive = noSaveElement ? noSaveElement.checked : false;
        if (!noSaveActive) {
          userColorSelect.value = randomColor;
          updateColorPreview(randomColor);
          localStorage.setItem('user-color', randomColor);
          localStorage.setItem('selected-champion', randomChampion);
          localStorage.setItem('lol-tracker-nickname', randomChampion);
        }
        
        updatePreview();
      });

      document.getElementById('clearAll').addEventListener('click', (e) => {
        const btn = e.target;
        btn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          btn.style.transform = 'scale(1)';
        }, 100);
        
        // Desactivar Diana easter egg si está activo
        if (dianaEffectsActive) {
          dianaEffectsActive = false;
          document.body.classList.remove('diana-mode');
          
          // Restaurar elementos
          const appIcon = document.querySelector('.app-icon');
          const title = document.querySelector('h1');
          const joinBtn = document.getElementById('joinRoomBtn');
          const soloBtn = document.getElementById('soloBtn');
          const createBtn = document.getElementById('createRoomBtn');
          
          if (dianaPulseInterval) {
            clearInterval(dianaPulseInterval);
            dianaPulseInterval = null;
          }
          
          appIcon.src = './images/Flash.png';
          title.textContent = 'LoL Flash Tracker';
          joinBtn.innerHTML = originalJoinText;
          soloBtn.innerHTML = originalSoloText;
          createBtn.innerHTML = originalCreateText;
          
          // Restaurar favicon
          const favicon = document.querySelector('link[rel="icon"]');
          favicon.href = './images/Flash.png';
          
          // Limpiar configuraciones temporales de Diana
          window.tempDianaColor = null;
          window.tempDianaChampion = null;
        }
        
        // Limpiar nombre
        elements.nicknameInput.value = '';
        
        // Limpiar campeón
        championInput.value = '';
        updateChampionPreview('');
        
        // Limpiar color
        userColorSelect.value = '';
        document.getElementById('colorPicker').value = '#bb86fc';
        updateColorPreview('');
        const noSaveActive = document.getElementById('noSaveOptions').checked;
        if (!noSaveActive) {
          localStorage.removeItem('user-color');
        }
        
        // Actualizar previews
        updatePreview();
      });

      document.getElementById('testDiana').addEventListener('click', () => {
        const dianaName = currentLang === 'es' ? 'Diana, El desdén de la Luna' : 'Diana, Scorn of the Moon';
        elements.nicknameInput.value = dianaName;
        elements.nicknameInput.dispatchEvent(new Event('input'));
        
        // Force Diana easter egg activation
        const btn = document.getElementById('championButton');
        btn.style.transform = 'scale(1)';
        btn.style.filter = 'grayscale(1)';
        btn.style.pointerEvents = 'none';
        btn.style.opacity = '0.5';
        
        // Activate Diana background
        document.body.classList.add('diana-mode');
        
        // Set Diana champion icon (temporary only)
        const championInput = document.getElementById('championInput');
        championInput.value = 'Diana';
        const championPreview = document.getElementById('championPreview');
        championPreview.src = './Champions_assets/Diana.png';
        championPreview.style.display = 'block';
        
        // Set Diana gradient color (temporary only)
        document.getElementById('userColor').value = '';
        document.getElementById('colorPicker').value = '#87ceeb';
        document.getElementById('colorPreview').style.background = 'linear-gradient(45deg, #ffffff, #87ceeb)';
        

        
        // Store temporary Diana settings
        window.tempDianaColor = 'linear-gradient(45deg, #ffffff, #87ceeb)';
        window.tempDianaChampion = 'Diana';
        updatePreview();
        
        // Play sound
        const audio = new Audio('./sound/Diana_Select.ogg');
        audio.play().catch(() => {});
        
        // Change buttons
        const joinBtn = document.getElementById('joinRoomBtn');
        const soloBtn = document.getElementById('soloBtn');
        const createBtn = document.getElementById('createRoomBtn');
        originalJoinText = joinBtn.innerHTML;
        originalSoloText = soloBtn.innerHTML;
        originalCreateText = createBtn.innerHTML;
        
        joinBtn.innerHTML = `<span>🌙</span> <span>${t('followLunari')}</span>`;
        soloBtn.innerHTML = `<span>⚔️</span> <span>${t('fightSolari')}</span>`;
        createBtn.innerHTML = `<span>🌙</span> <span>Reveal the Truth</span>`;
        joinBtn.style.background = 'linear-gradient(45deg, #1e3a8a, #3730a3)';
        soloBtn.style.background = 'linear-gradient(45deg, #374151, #1f2937)';
        createBtn.style.background = 'linear-gradient(45deg, #0f172a, #1e293b)';
        createBtn.style.border = '2px solid #e5e7eb';
        joinBtn.style.boxShadow = '0 0 15px rgba(30, 58, 138, 0.5)';
        soloBtn.style.boxShadow = '0 0 15px rgba(55, 65, 81, 0.5)';
        createBtn.style.boxShadow = '0 0 15px rgba(15, 23, 42, 0.7)';
        
        // Change icon and title
        const appIcon = document.querySelector('.app-icon');
        const title = document.querySelector('h1');
        
        title.style.opacity = '0';
        title.style.transform = 'translateY(-20px)';
        appIcon.style.transform = 'scale(0.8) rotate(-10deg)';
        
        setTimeout(() => {
          appIcon.src = './Champions_assets/Diana.png';
          title.innerHTML = `<span style="filter: grayscale(1) brightness(2);">🌙</span> ${t('dianaText')} <span style="filter: grayscale(1) brightness(2);">🌙</span>`;
          title.style.opacity = '1';
          title.style.transform = 'translateY(0) scale(1)';
          appIcon.style.transform = 'scale(1.1) rotate(5deg)';
          
          // Change favicon
          const favicon = document.querySelector('link[rel="icon"]');
          favicon.href = './Champions_assets/Diana.png';
          
          // Update preview with Diana icon and gradient
          updatePreview();
          
          // Start pulsing every 2 seconds
          dianaPulseInterval = setInterval(() => {
            title.style.transform = 'translateY(0) scale(1.15)';
            appIcon.style.transform = 'scale(1.15) rotate(5deg)';
            
            setTimeout(() => {
              title.style.transform = 'translateY(0) scale(1)';
              appIcon.style.transform = 'scale(1.1) rotate(5deg)';
            }, 300);
          }, 2000);
        }, 200);
        
        dianaEffectsActive = true;
        
        setTimeout(() => {
          btn.style.filter = '';
          btn.style.pointerEvents = '';
          btn.style.opacity = '';
        }, 3000);
      });
      
      document.getElementById('clearAllData').addEventListener('click', () => {
        localStorage.clear();
        sessionStorage.clear();
        // Clear all data including champion, color, and auto-copy
        championInput.value = '';
        updateChampionPreview('');
        userColorSelect.value = '';
        document.getElementById('colorPicker').value = '#bb86fc';

        document.getElementById('clearColor').style.transform = 'scale(1)';
        updateColorPreview('');
        updatePreview();
        showToast(currentLang === 'es' ? 'Todos los datos han sido eliminados' : 'All data has been cleared', 'success', 2000);
        setTimeout(() => location.reload(), 1000);
      });

      document.getElementById('advancedSettings').addEventListener('toggle', (e) => {
        const helpBtn = document.getElementById('helpBtn');
        helpBtn.style.display = e.target.open ? 'flex' : 'none';
        if (!e.target.open) {
          helpBtn.classList.remove('active');
          document.querySelectorAll('.help-text').forEach(el => {
            el.style.opacity = '0';
            setTimeout(() => el.style.display = 'none', 300);
          });
        }
      });

      document.getElementById('helpBtn').addEventListener('click', (e) => {
        e.stopPropagation();
        const btn = e.target;
        const isActive = btn.classList.contains('active');
        
        btn.classList.toggle('active');
        
        document.querySelectorAll('.help-text').forEach(el => {
          if (isActive) {
            el.style.opacity = '0';
            el.style.maxHeight = '0';
            el.style.padding = '0';
            setTimeout(() => el.style.display = 'none', 400);
          } else {
            el.style.display = 'block';
            setTimeout(() => {
              el.style.opacity = '1';
              el.style.maxHeight = '100px';
              el.style.padding = '4px 0';
            }, 10);
          }
        });
      });
    }

    // Efectos de chispas para el icono Flash
    let flashCooldown = false;
    
    function createFlashSparkles(icon) {
      if (flashCooldown) return;
      
      flashCooldown = true;
      setTimeout(() => {
        flashCooldown = false;
      }, 3000);
      
      // Efecto de click
      icon.style.transform = 'scale(0.95)';
      setTimeout(() => {
        icon.style.transform = 'scale(1.1) rotate(5deg)';
      }, 150);
      
      const sparkleCount = Math.floor(Math.random() * 12) + 8;
      const spellImages = [
        './images/Flash.png',
        './images/SummonerBarrier.png',
        './images/SummonerBoost.png',
        './images/SummonerDot.png',
        './images/SummonerExhaust.png',
        './images/SummonerHaste.png',
        './images/SummonerHeal.png',
        './images/SummonerSmite.png',
        './images/SummonerTeleport.png'
      ];
      
      for (let i = 0; i < sparkleCount; i++) {
        const sparkle = document.createElement('img');
        sparkle.src = spellImages[Math.floor(Math.random() * spellImages.length)];
        
        const randomX = (Math.random() - 0.5) * 300;
        const randomY = (Math.random() - 0.5) * 300;
        
        const startX = Math.random() * window.innerWidth;
        const startY = Math.random() * window.innerHeight;
        
        sparkle.style.cssText = `
          position: fixed;
          left: ${startX}px;
          top: ${startY}px;
          pointer-events: none;
          width: ${Math.random() * 20 + 15}px;
          height: ${Math.random() * 20 + 15}px;
          z-index: 9999;
          --random-x: ${randomX}px;
          --random-y: ${randomY}px;
          animation: flashSparkle ${Math.random() * 1.5 + 1.5}s ease-out forwards;
        `;
        
        document.body.appendChild(sparkle);
        
        setTimeout(() => sparkle.remove(), 3000);
      }
    }
    
    // Detección de invitación
    function checkInviteUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const inviteCode = urlParams.get('invite');
      
      if (inviteCode) {
        console.log('Invitación detectada:', inviteCode);
        
        // Verificar si hay datos guardados
        const hasUserData = localStorage.getItem('lol-tracker-nickname') || localStorage.getItem('selected-champion') || localStorage.getItem('user-color');
        console.log('Datos encontrados:', {
          nickname: localStorage.getItem('lol-tracker-nickname'),
          champion: localStorage.getItem('selected-champion'),
          color: localStorage.getItem('user-color')
        });
        
        if (hasUserData) {
          // Unirse directamente - redirigir al tracker con datos
          console.log('Datos encontrados, redirigiendo al tracker...');
          const nickname = localStorage.getItem('lol-tracker-nickname') || '';
          const champion = localStorage.getItem('selected-champion') || '';
          const color = localStorage.getItem('user-color') || '';
          
          const params = new URLSearchParams({
            autoJoin: inviteCode,
            nick: nickname,
            champion: champion,
            color: color
          });
          
          window.location.href = `lol-spell-tracker.html?${params.toString()}`;
          return true;
        } else {
          // Mostrar mensaje de invitación
          showInviteMessage(inviteCode);
        }
        
        return true;
      }
      return false;
    }
    
    function showInviteMessage(code) {
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #4ecdc4, #45b7d1);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        font-size: 0.9rem;
        text-align: center;
      `;
      messageDiv.innerHTML = `
        📨 <strong>You've been invited to join room: ${code}</strong><br>
        <small>Customize your profile below, then click "Join Room" to connect!</small>
      `;
      
      document.body.appendChild(messageDiv);
      
      // Auto-llenar el campo de room ID
      setTimeout(() => {
        const roomInput = document.getElementById('roomId');
        if (roomInput) {
          roomInput.value = code;
        }
      }, 100);
      
      // Remover mensaje después de 8 segundos
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 8000);
    }

    // ====================== INICIO DE LA APLICACIÓN ======================
    window.addEventListener('load', () => {
      // Verificar invitación antes de inicializar
      checkInviteUrl();
      loadSettings();
      setupEventListeners();
      updateRoleUI();
      
      setupCustomizeButton();

      
      setTimeout(() => {
        elements.nicknameInput.focus();
      }, 500);

      updateStatus(t('readyToUse'), 'success');
    });
  </script>
</body>
</html>